# 📖 GAS Webhook セットアップガイド

## 🎯 目的

LINE WORKSのBotを使って、トークルームのメッセージをリアルタイムでGoogle Sheetsに保存します。

---

## ⚙️ セットアップ手順

### ステップ1: Webhook設定状況を確認

Apps Scriptエディタで以下を実行：

```javascript
checkWebhookStatus()
```

この関数は以下を確認します：
- Web Appのデプロイ状況
- Bot ID/Secretの設定状況
- 在庫管理専用チャットログの設定状況

### ステップ2: Webhook URLを取得

Web Appがデプロイ済みの場合、以下を実行：

```javascript
getWebhookUrl()
```

または：

```javascript
showWebhookSetupGuide()
```

実行ログに表示されたURLをコピーしてください。

例：
```
https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXX/exec
```

**⚠️ 注意**: Web Appがデプロイされていない場合は、次のステップでデプロイしてください。

---

### ステップ3: Web Appとしてデプロイ（初回のみ）

**重要**: Webhookを有効にするには、プロジェクトを「Web App」としてデプロイする必要があります。

1. Apps Scriptエディタで「デプロイ」→「新しいデプロイ」
2. タイプ選択：「ウェブアプリ」
3. 設定：
   - **説明**: LINE WORKS Webhook（任意）
   - **次のユーザーとして実行**: 自分
   - **アクセスできるユーザー**: **全員**（重要！）
4. 「デプロイ」をクリック
5. 表示されたURLをコピー

---

### ステップ4: LINE WORKS Developer Console設定

1. **LINE WORKS Developer Consoleにアクセス**
   ```
   https://developers.worksmobile.com/
   ```

2. **Bot「日向」(ID: 10746138)を選択**

3. **Callback URLを設定**
   - 「Callback URL」項目に、ステップ1で取得したURLを貼り付け
   ```
   https://script.google.com/macros/s/XXXXXXXXXXXXXXXXXXXX/exec
   ```

4. **保存**
   - 保存すると自動的に検証が実行されます
   - GASが「チャレンジレスポンス」を返すので検証成功します

5. **検証成功の確認**
   - ✅ マークまたは「検証成功」と表示されればOK

---

### ステップ5: Botをトークルームに追加

#### 通常のチャットログ用（マスターログ）

1. **LINE WORKSアプリを開く**

2. **「日报」トークルームを開く**
   - チャンネルID: `2ddfe141-b9d5-6c2a-8027-43e009a916bc`

3. **メニュー → メンバー追加**

4. **Bot「日向」を検索して追加**

#### 在庫管理専用チャンネル

1. **在庫管理専用チャンネルを開く**
   - チャンネルID: `7d6b452d-2dce-09ac-7663-a2f47d622e91`

2. **メニュー → メンバー追加**

3. **Bot「日向」を検索して追加**

**💡 重要**: 在庫管理専用チャンネルのメッセージは、専用のスプレッドシート「在庫管理チャットログ」に保存されます。

---

### ステップ6: 動作確認

#### テスト1: Apps Scriptでテスト

**通常のチャットログ:**
```javascript
testWebhook()
```

**在庫管理専用チャンネル:**
```javascript
testWebhookStockChannel()
```

実行して、スプレッドシートに「テストメッセージ」が追加されることを確認。

#### テスト2: 実際のメッセージで確認

**通常のチャットログ:**
1. LINE WORKSの「日报」トークルームでメッセージを送信：
   ```
   テスト: Webhook動作確認
   ```

2. **Google Sheetsを確認**
   - 場所: `マイドライブ/LINE WORKS統合ログ/チャットログ/マスターログ`
   - シート: 「メッセージ一覧」
   - 最新行にメッセージが追加されているはず

**在庫管理専用チャンネル:**
1. LINE WORKSの在庫管理専用チャンネルでメッセージを送信：
   ```
   みどりの大地にじゃがいも10個入荷しました
   ```

2. **Google Sheetsを確認**
   - 場所: `マイドライブ/LINE WORKS統合ログ/チャットログ/在庫管理チャットログ`
   - シート: 「メッセージ一覧」
   - 最新行にメッセージが追加されているはず

3. **Apps Scriptの実行ログを確認**
   ```
   ✅ 在庫管理専用チャットログに保存: XXX - みどりの大地にじゃがいも10個入荷しました
   ```

4. **在庫管理システムに反映**
   - `2_Stock_Manager`プロジェクトで `testAnalyzeStockChatLog()` を実行
   - メッセージを解析して在庫管理システムに反映

---

## 🎉 完了！

これで以下が実現します：

✅ **リアルタイム保存**
- 「日报」トークルームのメッセージが自動的にGoogle Sheetsに保存
- 在庫管理専用チャンネルのメッセージも専用スプレッドシートに自動保存

✅ **全メッセージタイプに対応**
- テキスト、画像、ファイル、スタンプ、位置情報

✅ **自動分類**
- 在庫管理専用チャンネルのメッセージは自動的に専用スプレッドシートに保存
- 通常のチャットはマスターログに保存

✅ **Vercel不要**
- GAS単体で動作（Vercelはバックアップとして継続可能）

---

## 🔍 トラブルシューティング

### エラー: Callback URL検証失敗

**原因**: Web Appとしてデプロイされていない、またはアクセス権限が「全員」になっていない

**解決策**:
1. Apps Scriptで「デプロイ」→「デプロイを管理」
2. アクセス権限を「全員」に変更
3. 「デプロイを更新」

---

### エラー: メッセージが保存されない

**原因1**: Botがトークルームに追加されていない

**解決策**: 
- 「日报」トークルームのメンバー一覧で「日向」が表示されるか確認

**原因2**: Callback URLが間違っている

**解決策**:
```javascript
ScriptApp.getService().getUrl()
```
を実行して、正しいURLを再確認

---

### エラー: 署名検証失敗

**原因**: BOT_SECRETが間違っている

**解決策**:
1. `Config.gs` の `BOT_SECRET` を確認
2. Developer Consoleで正しい値を確認
3. 一致しない場合は更新

---

## 📊 運用確認

### 統計確認

```javascript
getVercelIntegrationStats()
```

### 手動同期（バックアップ用）

```javascript
syncChatLogs()
```

---

## 💡 次のステップ

### オプション: Vercel統合（デュアルシステム）

Vercelシステムも継続して、二重バックアップ体制にする場合：

1. `VERCEL_INTEGRATION_CODE.md` を参照
2. VercelからGASへの転送も設定
3. Redis + Google Sheets 両方に保存

これにより、万が一どちらかが障害でもデータ損失なし！

---

## 📞 サポート

問題が解決しない場合は、以下を確認してください：

1. Apps Scriptの実行ログ
2. LINE WORKS Developer Consoleのログ
3. Google Sheetsの「メッセージ一覧」シート

それでも解決しない場合は、エラーメッセージをお知らせください。

---

✅ セットアップ完了したら、「日报」でメッセージを送信してテストしてください！





