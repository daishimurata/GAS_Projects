# 月次ログフォルダ機能ガイド

## 📚 概要

ログファイルを月ごとのフォルダに自動整理する機能が追加されました。この機能により、ログの管理が格段に容易になります。

## 🎯 主な変更点

### 1. 新しいフォルダ構造

```
/LINE WORKS統合ログ/
├── システムログ/          ← 🆕
│   ├── 2025-01/
│   │   └── 同期ログ.txt
│   ├── 2025-02/
│   │   └── 同期ログ.txt
│   └── ...
│
└── チャットログ/
    ├── 日次ログ/            ← 🆕 月次整理
    │   ├── 2025-01/
    │   │   ├── 2025-01-15_全体ログ.txt
    │   │   └── ...
    │   └── ...
    │
    ├── ルーム別ログ/         ← 🆕 月次整理
    │   ├── 2025-01/
    │   │   ├── ルーム名_履歴.txt
    │   │   └── ...
    │   └── ...
    │
    └── 添付ファイル/         ← 既存（月次整理済み）
        ├── 2025-01/
        └── ...
```

### 2. 設定オプション

`Config.gs` に以下の設定が追加されました：

```javascript
GOOGLE_DRIVE: {
  SYSTEM_LOG_FOLDER: 'システムログ',     // 新規追加
  MONTHLY_ORGANIZATION: true              // デフォルト: 有効
}
```

## ✨ 機能のメリット

### 1. **整理整頓**
- 月ごとに自動的にフォルダ分けされるため、ログが見やすい
- 特定月のログを素早く見つけられる

### 2. **容量管理**
- ファイルサイズが大きくなりすぎるのを防ぐ
- 古い月のフォルダを簡単にアーカイブ・削除できる

### 3. **パフォーマンス向上**
- フォルダ内のファイル数が減るため、検索が高速化
- Googleドライブの表示が軽快に

### 4. **監査とコンプライアンス**
- 月単位でのログ保管が容易
- 必要な期間のみ保持する運用がしやすい

## 🚀 使い方

### 初回設定（既存ユーザー向け）

既存のログファイルを月次フォルダに移行する場合：

```javascript
// GASエディタで実行
migrateAllLogsToMonthly();
```

実行すると：
1. ルートフォルダの `同期ログ.txt` → `システムログ/YYYY-MM/` に移動
2. 日次ログフォルダの全ファイル → `日次ログ/YYYY-MM/` に移動
3. ルーム別ログフォルダの全ファイル → `ルーム別ログ/YYYY-MM/` に移動

### 新規ユーザー

特に設定不要です。`initialSetup()` 実行後、自動的に月次フォルダに保存されます。

### 月次整理を無効にしたい場合

`Config.gs` で以下を変更：

```javascript
GOOGLE_DRIVE: {
  MONTHLY_ORGANIZATION: false  // false に設定
}
```

## 🔧 管理機能

### 1. 個別移行

```javascript
// システムログのみ移行
migrateSystemLogsToMonthly();

// チャットログのみ移行
migrateChatLogsToMonthly();
```

### 2. 古いログのアーカイブ

12ヶ月より古いログフォルダを自動アーカイブ：

```javascript
archiveOldMonthlyLogs(12);
```

実行結果：
- `2024-01`、`2024-02` など古い月のフォルダが `/アーカイブ` フォルダに移動
- 現在から12ヶ月以内のログは残る

### 3. 定期アーカイブの自動化

トリガーを設定して定期実行も可能：

```
関数: archiveOldMonthlyLogs
イベントソース: 時間主導型
時刻ベース: 月タイマー（毎月1日）
引数: 12
```

## 📝 技術詳細

### 変更されたファイル

1. **Config.gs**
   - `SYSTEM_LOG_FOLDER` 追加
   - `MONTHLY_ORGANIZATION` フラグ追加

2. **Utils.gs**
   - `appendToSyncLog()` を月次対応に変更
   - `getMonthFolderName()` 関数追加

3. **ChatLogger.gs**
   - `saveRoomLog()` を月次対応に変更
   - `saveDailyLog()` を月次対応に変更

4. **MigrateToMonthly.gs** 🆕
   - 既存ログの移行関数群
   - アーカイブ機能

### 月フォルダ命名規則

- 形式: `YYYY-MM` （例: `2025-01`, `2025-11`）
- タイムゾーン: Asia/Tokyo
- ファイルの最終更新日に基づいて振り分け

## ⚠️ 注意事項

### 1. 既存ログの移行について

- **バックアップ推奨**: 移行実行前に重要なログはバックアップを取ることを推奨
- **一度きりの実行**: 移行関数は基本的に1回のみ実行すればOK
- **元に戻せます**: 必要に応じてファイルを手動で元のフォルダに戻せます

### 2. ディスク容量について

- 月次フォルダ機能自体は容量を増やしません（整理するだけ）
- 定期的なアーカイブ・削除運用を推奨

### 3. Geminiとの連携

- 月次フォルダでもGeminiは問題なくアクセス可能
- フォルダ全体を共有設定すれば、サブフォルダも自動的に共有される

## 🔄 移行前後の比較

### Before（従来）
```
/LINE WORKS統合ログ/
├── 同期ログ.txt                    ← 1つの巨大ファイル
├── チャットログ/
│   ├── 日次ログ/
│   │   ├── 2024-01-01_全体ログ.txt
│   │   ├── 2024-01-02_全体ログ.txt
│   │   ├── ...
│   │   └── 2025-11-10_全体ログ.txt  ← 100件以上のファイルが混在
│   └── ルーム別ログ/
│       └── （同様に大量のファイル）
```

### After（月次整理後）
```
/LINE WORKS統合ログ/
├── システムログ/
│   ├── 2024-01/
│   │   └── 同期ログ.txt
│   └── 2025-11/
│       └── 同期ログ.txt              ← 月ごとに分離
├── チャットログ/
│   ├── 日次ログ/
│   │   ├── 2024-01/
│   │   │   └── （1月分のみ）
│   │   └── 2025-11/
│   │       └── （11月分のみ）        ← スッキリ整理
│   └── ルーム別ログ/
│       └── （同様に月別整理）
```

## 💡 ベストプラクティス

### 1. 保持期間の設定

業務要件に応じて設定：

- **一般的**: 12ヶ月保持、それ以前はアーカイブ
- **コンプライアンス重視**: 24ヶ月以上保持
- **容量節約**: 6ヶ月保持、定期削除

### 2. アーカイブの運用

```javascript
// 毎月1日に自動実行（トリガー設定）
function monthlyMaintenance() {
  // 12ヶ月より古いログをアーカイブ
  archiveOldMonthlyLogs(12);
  
  // アーカイブフォルダ内の24ヶ月より古いログを削除
  // （手動または別スクリプトで実行）
}
```

### 3. バックアップ戦略

重要なログは定期的に：
1. Googleドライブの「マイドライブに追加」でバックアップ
2. または外部ストレージにエクスポート

## 🆘 トラブルシューティング

### Q1. 移行関数を実行したがファイルが移動しない

**A**: 以下を確認：
- `CONFIG.GOOGLE_DRIVE.MONTHLY_ORGANIZATION` が `true` か確認
- ファイル名が正しい形式（日付を含む）か確認
- ログを確認してエラーメッセージを確認

### Q2. 移行後に元に戻したい

**A**: 手動でファイルを元のフォルダに移動：
1. Googleドライブで該当フォルダを開く
2. ファイルを選択して「移動」
3. 元のフォルダに移動

または、`Config.gs` で `MONTHLY_ORGANIZATION: false` に設定すれば、以降は従来通りに保存されます。

### Q3. アーカイブしたログを確認したい

**A**: 
1. Googleドライブで `/LINE WORKS統合ログ/アーカイブ` フォルダを開く
2. 必要なフォルダを元の場所に戻す

## 📞 サポート

問題が発生した場合は、管理者にLINE WORKSでお問い合わせください。

---

**作成日**: 2025年11月10日  
**バージョン**: 1.1.0  
**対応機能**: 月次ログフォルダ整理機能

