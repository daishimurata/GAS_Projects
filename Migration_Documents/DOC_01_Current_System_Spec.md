# 現行システム仕様書・解析レポート

## 1. システム全体像

現在、以下の3つの主要なGASプロジェクトが稼働しており、それぞれが連携して業務を自動化しています。

### プロジェクト構成
1. **1_LineLog_Collector**: LINE WORKSのカレンダー・チャットログ収集とGoogle同期
2. **2_Stock_Manager**: 売上報告メールの解析、在庫管理、LINE通知、売上集計
3. **3_LineLog_Analyzer**: 収集したログのAI解析（Gemini連携）

---

## 2. 各プロジェクトの詳細仕様

### 2.1. 1_LineLog_Collector (LINE WORKS統合ログ収集)

**目的**: LINE WORKS上のフロー情報（チャット、予定）をGoogle Workspace上のストック情報（ドライブ、カレンダー、スプレッドシート）に変換・保存する。

**主要機能**:
- **カレンダー同期 (`CalendarSync.gs`)**:
    - LINE WORKSの全メンバーのカレンダーを取得。
    - Googleカレンダーへイベントを同期（作成・更新・削除）。
    - イベントタイトルに「[氏名]」を付与して識別。
    - 同期範囲: 過去7日〜未来60日。
- **チャットログ収集 (`ChatSync.gs`, `ChatLogger.gs`)**:
    - Botが参加している全チャンネルのメッセージを取得。
    - Googleドライブにログ保存（日次テキスト、月次フォルダ分け）。
    - マスタースプレッドシートへ構造化データとして蓄積。
    - 添付ファイルのダウンロード保存。
- **Webhookハンドリング (`WebhookHandler.gs`)**:
    - リアルタイムでのメッセージ受信処理（Vercel連携の形跡あり）。

**技術特徴**:
- JWT認証によるLINE WORKS API利用。
- `CacheService`を用いたトークン管理。
- 大量データ処理のためのバッチ保存実装。

### 2.2. 2_Stock_Manager (在庫・売上管理システム)

**目的**: 各店舗からの売上報告メールを自動処理し、在庫表の更新と速報通知を行う。

**主要機能**:
- **メール解析 (`SalesEmailAnalyzer.gs`)**:
    - Gemini APIを活用し、非定型の売上報告メールから「店舗名」「商品名」「販売数」「売上金額」を抽出。
    - 店舗名のゆらぎ吸収（「みどりの大地」「Aコープ」など）。
- **在庫管理 (`StockManagement.gs`)**:
    - メールから抽出した販売数を在庫マスター（スプレッドシート）から減算。
    - 差分更新ロジックにより、累計報告メールにも対応。
- **アラート通知**:
    - 在庫数が発注点を下回った場合のアラート（※一部無効化設定あり）。
    - LINE WORKSへの売上速報通知。
- **日次集計**:
    - 店舗・商品別の日次売上レポート生成。

**データ構造**:
- **在庫管理シート**: 商品マスタ、現在庫、発注点、単価。
- **売上履歴シート**: トランザクションログ。

### 2.3. 3_LineLog_Analyzer (ログ解析)

**目的**: 蓄積されたログデータをAI（Gemini）で分析し、インサイトを抽出する。

**主要機能**:
- **コンテキスト管理 (`ContextManager.gs`)**: 過去の会話の流れを維持した解析。
- **ログ解析 (`LogAnalyzer.gs`)**: テキストログを読み込み、要約や重要事項の抽出を行う。

---

## 3. インフラ・依存関係

### Google Drive 構造
- `/LINE WORKS統合ログ/`: チャットログ、カレンダーデータの保存先。
- `/在庫管理/`: 在庫管理スプレッドシート、売上ログの保存先。
- `/システムログ/`: 各システムの実行エラーログなど。

### 外部API
- **LINE WORKS API**: Calendar, Bot, Audit, Directory 各APIを使用。
- **Gemini API**: メールの非構造化データ抽出、チャットログの要約に使用。

### 注意事項・制約
- **APIレート制限**: LINE WORKS APIおよびGmail APIの制限に配慮した設計（Wait処理など）が必要。
- **実行時間制限**: GASの6分制限への対策（一部バッチ処理化されているが、データ量増加時は注意）。
- **認証**: JWT認証用の秘密鍵（`private_key`）の管理が最重要。

---

## 4. 移行に向けた課題

1. **モジュール間の結合度**: 現在はプロジェクトが分かれているが、共通のUtilityやConfigの重複が見られる。統合プロジェクト化することで保守性を向上できる。
2. **設定の散逸**: 設定値（ID等）が各プロジェクトの `Config.gs` に分散している。
3. **エラーハンドリング**: 統一された通知基盤（Slack/LINE WORKS通知）への集約が望ましい。

この現状分析に基づき、次項の「引き継ぎ資料」および「移行計画」を作成します。
