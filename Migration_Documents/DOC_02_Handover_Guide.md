# プロジェクト引き継ぎ資料

## 1. はじめに

本資料は、「LINE WORKS統合ログシステム」および「在庫管理システム」の運用・保守を引き継ぐプロジェクトマネージャーおよびエンジニア向けのガイドです。
本システムはGoogle Apps Script (GAS) 上で動作し、LINE WORKS APIおよびGoogle Workspaceの各サービスと連携しています。

## 2. 重要ファイル・リソース一覧

### 2.1. プロジェクト構成
現在、Googleドライブ上の `GAS_Projects` フォルダにて以下の3つのスクリプトプロジェクトとして管理されています。

| プロジェクト名 | フォルダ | 役割 | 重要度 |
|---|---|---|---|
| **1_LineLog_Collector** | `1_LineLog_Collector` | チャット・カレンダー同期のコアシステム | ★★★ |
| **2_Stock_Manager** | `2_Stock_Manager` | 売上メール処理・在庫管理 | ★★★ |
| **3_LineLog_Analyzer** | `3_LineLog_Analyzer` | AIによるログ解析・要約 | ★★☆ |

### 2.2. 運用上の重要スプレッドシート
以下のスプレッドシートがデータベースとして機能しています。削除や構造変更は慎重に行ってください。

1. **在庫管理シート** (`/在庫管理/直売所管理システム`)
   - **在庫管理**: 商品マスタ、現在庫データ。
   - **売上履歴**: 自動記録された売上ログ。
   - **店舗設定**: 店舗名判定用のキーワード設定。

2. **チャットマスターログ** (`/LINE WORKS統合ログ/チャットログ/マスターログ`)
   - 過去のチャット履歴が蓄積されています。サイズが大きくなりすぎた場合はアーカイブが必要です。

---

## 3. 設定変更・メンテナンス手順

### 3.1. 商品の追加・変更
「在庫管理シート」の「在庫管理」シートを直接編集します。
- **商品追加**: 新しい行に行を追加し、店舗名、商品名、初期在庫などを入力してください。
- **キーワード設定**: 「別名キーワード」列に、メールで送られてくる可能性のある略称をカンマ区切りで入力します（例: `ミニトマト, トマト, mini tomato`）。

### 3.2. LINE WORKS API認証の更新
認証エラー通知（401/403エラー）が届いた場合、認証情報の有効期限切れや設定変更が疑われます。
- `1_LineLog_Collector/Config.gs` 内の `LINEWORKS` 設定を確認してください。
- 秘密鍵の再発行が必要な場合は、LINE WORKS Developer Consoleで発行し、`Config.gs` の `PRIVATE_KEY` を更新してください。

### 3.3. 通知先の変更
エラー通知やレポートの送信先を変更する場合：
- **管理者LINE**: 各プロジェクトの `Config.gs` 内 `NOTIFICATION.ADMIN_USER_ID` を変更。
- **通知先チャンネル**: `Config.gs` または各通知関数の宛先IDを変更。

---

## 4. トラブルシューティング

### Q1. 「在庫が更新されない」と連絡が来た
1. **メール確認**: 対象の売上報告メールがGmailに届いているか確認してください。
2. **実行ログ確認**: `2_Stock_Manager` の実行ログを確認し、エラーが出ていないかチェック。
   - 「店舗判定不可」の場合は、メール本文内の店舗名キーワードを確認し、「店舗設定」シートを更新してください。
   - 「Gemini抽出エラー」の場合は、メールフォーマットが大きく変わった可能性があります。

### Q2. カレンダーが同期されていない
1. **API権限**: 対象ユーザーのカレンダー対してAPI権限があるか確認（LINE WORKS側）。
2. **IDマッピング**: `1_LineLog_Collector` のスクリプトプロパティに保存されているマッピング情報が破損している可能性があります。スクリプトプロパティの確認・クリアを検討してください。

### Q3. 「ScriptError: Exceeded maximum execution time」が発生する
データ量が増加し、6分の壁を超えています。
- 一度の処理対象期間（`SYNC.CALENDAR_PAST_DAYS` など）を短くする設定変更を行ってください。
- または、トリガーの実行頻度を上げることで1回あたりの処理量を減らしてください。

---

## 5. 今後の拡張について（推奨）

現在、システムの再構築（Antigravityプロジェクトへの移行）が計画されています。
新システムでは、これら3つのプロジェクトが統合され、より堅牢な設計（Clean Architecture、TypeScriptライクなクラス設計）に生まれ変わる予定です。
新規機能追加は、可能な限り新システム側で行うことを推奨します。
